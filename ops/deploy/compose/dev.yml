name: gryt-dev

services:
  # SFU Server (Media Forwarding)
  sfu:
    build:
      context: ../../../packages/sfu
    container_name: gryt-sfu
    ports:
      - "${SFU_WS_PORT:-5006}:5005"
      # Optional: publish a fixed UDP port range for WebRTC media (recommended in production)
      # - "${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}:${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}/udp"
    environment:
      - PORT=5005
      - STUN_SERVERS=stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302
      # Optional: pin ICE UDP ports + capacity and control what IP is advertised in ICE candidates
      # - ICE_UDP_PORT_MIN=${SFU_UDP_MIN:-10000}
      # - ICE_UDP_PORT_MAX=${SFU_UDP_MAX:-10019}
      # - ICE_ADVERTISE_IP=${SFU_ADVERTISE_IP:-}
      # - DISABLE_STUN=${SFU_DISABLE_STUN:-false}
    volumes:
      - ../../../packages/sfu/.env:/root/.env:ro
    networks:
      - gryt-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5005/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Gryt Server 1 (Signaling)
  server1:
    build:
      context: ../../../packages/server
    container_name: gryt-server-1
    ports:
      - "${SERVER1_PORT:-5001}:5000"
    environment:
      - PORT=5000
      - SERVER_NAME=Gryta Krutt
      - SFU_WS_HOST=ws://sfu:5005
      - STUN_SERVERS=stun:stun.l.google.com:19302
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3777,http://127.0.0.1:15738,https://app.gryt.chat}
      - SERVER_PASSWORD=changeme-1
      - GRYT_AUTH_MODE=required
      - GRYT_OIDC_ISSUER=https://auth.gryt.chat/realms/gryt
      - GRYT_OIDC_AUDIENCE=gryt-web
      - NODE_ENV=development
      - DATA_DIR=/data
      - SERVER_INSTANCE_ID=${SERVER_INSTANCE_ID_WS1:-ws1}
      - S3_ENDPOINT=http://gryt-dev-minio:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-gryt}
      - S3_FORCE_PATH_STYLE=true
      - JWT_SECRET=${JWT_SECRET:-dev-secret-do-not-use-in-production}
      # Optional: voice seat limit (derived if SFU_UDP_* set)
      # - SFU_UDP_PORT_MIN=${SFU_UDP_MIN:-10000}
      # - SFU_UDP_PORT_MAX=${SFU_UDP_MAX:-10019}
      # - VOICE_MAX_USERS=${VOICE_MAX_USERS:-}
    volumes:
      - ../../../packages/server/.env:/app/.env:ro
      - gryt-dev-server1-data:/data
    networks:
      - gryt-network
      - dev-deps
    depends_on:
      - sfu
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Gryt Server 2 (Signaling)
  server2:
    build:
      context: ../../../packages/server
    container_name: gryt-server-2
    ports:
      - "${SERVER2_PORT:-5002}:5000"
    environment:
      - PORT=5000
      - SERVER_NAME=Techial
      - SFU_WS_HOST=ws://sfu:5005
      - STUN_SERVERS=stun:stun.l.google.com:19302
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3777,http://127.0.0.1:15738,https://app.gryt.chat}
      - SERVER_PASSWORD=changeme-2
      - GRYT_AUTH_MODE=required
      - GRYT_OIDC_ISSUER=https://auth.gryt.chat/realms/gryt
      - GRYT_OIDC_AUDIENCE=gryt-web
      - NODE_ENV=development
      - DATA_DIR=/data
      - SERVER_INSTANCE_ID=${SERVER_INSTANCE_ID_WS2:-ws2}
      - S3_ENDPOINT=http://gryt-dev-minio:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-gryt}
      - S3_FORCE_PATH_STYLE=true
      - JWT_SECRET=${JWT_SECRET:-dev-secret-do-not-use-in-production}
      # Optional: voice seat limit (derived if SFU_UDP_* set)
      # - SFU_UDP_PORT_MIN=${SFU_UDP_MIN:-10000}
      # - SFU_UDP_PORT_MAX=${SFU_UDP_MAX:-10019}
      # - VOICE_MAX_USERS=${VOICE_MAX_USERS:-}
    volumes:
      - ../../../packages/server/.env:/app/.env:ro
      - gryt-dev-server2-data:/data
    networks:
      - gryt-network
      - dev-deps
    depends_on:
      - sfu
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Image Worker for Server 1
  image-worker-1:
    build:
      context: ../../../packages/image-worker
    container_name: gryt-image-worker-1
    environment:
      - DATA_DIR=/data
      - S3_ENDPOINT=http://gryt-dev-minio:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-gryt}
      - S3_FORCE_PATH_STYLE=true
    volumes:
      - gryt-dev-server1-data:/data
    networks:
      - gryt-network
      - dev-deps
    depends_on:
      server1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Image Worker for Server 2
  image-worker-2:
    build:
      context: ../../../packages/image-worker
    container_name: gryt-image-worker-2
    environment:
      - DATA_DIR=/data
      - S3_ENDPOINT=http://gryt-dev-minio:9000
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_BUCKET=${S3_BUCKET:-gryt}
      - S3_FORCE_PATH_STYLE=true
    volumes:
      - gryt-dev-server2-data:/data
    networks:
      - gryt-network
      - dev-deps
    depends_on:
      server2:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Web Client
  client:
    build:
      context: ../../../packages/client
    container_name: gryt-client
    ports:
      - "${CLIENT_HTTP_PORT:-3777}:80"
    environment:
      - GRYT_OIDC_ISSUER=https://auth.gryt.chat/realms/gryt
      - GRYT_OIDC_REALM=gryt
      - GRYT_OIDC_CLIENT_ID=gryt-web
    networks:
      - gryt-network
    depends_on:
      - server1
      - server2
    restart: unless-stopped
    healthcheck:
      # Use 127.0.0.1 (not localhost) to avoid IPv6 ::1 issues in wget
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  gryt-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  dev-deps:
    name: compose_default
    external: true

volumes:
  sfu-data:
  gryt-dev-server1-data:
  gryt-dev-server2-data:
