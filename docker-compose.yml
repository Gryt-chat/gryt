##############################################################################
# Gryt — Self-Hosted Docker Compose
#
# Spins up the Gryt backend using pre-built images from GHCR.
# No need to clone any repos — just this file + .env is enough.
#
# Core services: Server, SFU, ScyllaDB, MinIO
# Connect with the Gryt desktop app (Linux / macOS / Windows).
#
# Usage:
#   1. Copy .env.example to .env and edit it
#   2. docker compose up -d
#   3. Connect with the Gryt desktop app
#
# Optional — run the web client too:
#   docker compose --profile web up -d
#   Then open http://localhost:3666
#
# Images are published to ghcr.io/gryt-chat/* on every release.
##############################################################################

services:
  # ── Database ──────────────────────────────────────────────────────────────

  scylla:
    image: scylladb/scylla:latest
    container_name: gryt-scylla
    command: ["--overprovisioned", "1", "--smp", "1"]
    volumes:
      - scylla-data:/var/lib/scylla
    networks:
      - gryt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "DESCRIBE KEYSPACES"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  # ── Object Storage ───────────────────────────────────────────────────────

  minio:
    image: minio/minio:latest
    container_name: gryt-minio
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    networks:
      - gryt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  minio-init:
    image: minio/mc:latest
    container_name: gryt-minio-init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-gryt}
    entrypoint: ["/bin/sh", "-c"]
    command: |
      set -e
      echo "Configuring MinIO..."
      mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD"
      mc mb -p "local/$$S3_BUCKET" 2>/dev/null || true
      echo "Bucket ready: $$S3_BUCKET"
    networks:
      - gryt
    restart: "no"

  # ── SFU (Media Server) ──────────────────────────────────────────────────

  sfu:
    image: ghcr.io/gryt-chat/sfu:${SFU_VERSION:-latest}
    container_name: gryt-sfu
    ports:
      - "${SFU_PORT:-5005}:5005"
      - "${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}:${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}/udp"
    environment:
      PORT: "5005"
      STUN_SERVERS: ${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}
      ICE_UDP_PORT_MIN: ${SFU_UDP_MIN:-10000}
      ICE_UDP_PORT_MAX: ${SFU_UDP_MAX:-10019}
      ICE_ADVERTISE_IP: ${SFU_ADVERTISE_IP:-}
    networks:
      - gryt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── Signaling Server ─────────────────────────────────────────────────────

  server:
    image: ghcr.io/gryt-chat/server:${SERVER_VERSION:-latest}
    container_name: gryt-server
    ports:
      - "${SERVER_PORT:-5000}:5000"
    environment:
      PORT: "5000"
      NODE_ENV: production
      SERVER_NAME: ${SERVER_NAME:-My Gryt Server}
      SERVER_DESCRIPTION: ${SERVER_DESCRIPTION:-A Gryt voice chat server}
      SERVER_PASSWORD: ${SERVER_PASSWORD:-}
      SERVER_INVITE_ONLY: ${SERVER_INVITE_ONLY:-false}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3666,https://app.gryt.chat}
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
      SFU_WS_HOST: ws://sfu:5005
      SFU_PUBLIC_HOST: ${SFU_PUBLIC_HOST:-ws://localhost:5005}
      STUN_SERVERS: ${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}
      SFU_UDP_PORT_MIN: ${SFU_UDP_MIN:-10000}
      SFU_UDP_PORT_MAX: ${SFU_UDP_MAX:-10019}
      # Auth
      GRYT_AUTH_MODE: ${GRYT_AUTH_MODE:-disabled}
      GRYT_OIDC_ISSUER: ${GRYT_OIDC_ISSUER:-https://auth.gryt.chat/realms/gryt}
      GRYT_OIDC_AUDIENCE: ${GRYT_OIDC_AUDIENCE:-gryt-web}
      GRYT_AUTH_API: ${GRYT_AUTH_API:-https://auth.gryt.chat}
      # ScyllaDB
      SCYLLA_CONTACT_POINTS: scylla
      SCYLLA_LOCAL_DATACENTER: datacenter1
      SCYLLA_KEYSPACE: ${SCYLLA_KEYSPACE:-gryt}
      # S3 / MinIO
      S3_ENDPOINT: http://minio:9000
      S3_REGION: auto
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-gryt}
      S3_FORCE_PATH_STYLE: "true"
    depends_on:
      scylla:
        condition: service_healthy
      sfu:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    networks:
      - gryt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ── Web Client (optional) ────────────────────────────────────────────────
  # Most users connect via the Gryt desktop app (Electron).
  # Enable the web client with: docker compose --profile web up -d

  client:
    image: ghcr.io/gryt-chat/client:${CLIENT_VERSION:-latest}
    container_name: gryt-client
    profiles: ["web"]
    ports:
      - "${CLIENT_PORT:-3666}:80"
    environment:
      GRYT_OIDC_ISSUER: ${GRYT_OIDC_ISSUER:-https://auth.gryt.chat/realms/gryt}
      GRYT_OIDC_REALM: ${GRYT_OIDC_REALM:-gryt}
      GRYT_OIDC_CLIENT_ID: ${GRYT_OIDC_CLIENT_ID:-gryt-web}
    depends_on:
      server:
        condition: service_healthy
    networks:
      - gryt
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  gryt:
    driver: bridge

volumes:
  scylla-data:
  minio-data:
