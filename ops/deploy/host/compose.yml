services:
  client:
    build:
      context: ../..
      dockerfile: Dockerfile.client
    container_name: gryt-client
    env_file:
      - ./.env
    ports:
      - "${BIND_ADDR:-127.0.0.1}:${CLIENT_HTTP_PORT:-8080}:80"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      server:
        condition: service_healthy

  server:
    build:
      context: ../..
      dockerfile: Dockerfile.server
    container_name: gryt-server
    env_file:
      - ./.env
    environment:
      NODE_ENV: production
      PORT: "5000"
      # Internal SFU websocket (server -> sfu container)
      SFU_WS_HOST: "ws://sfu:5005"
      # Storage defaults to the containers below
      SCYLLA_CONTACT_POINTS: "scylla"
      SCYLLA_LOCAL_DATACENTER: "${SCYLLA_LOCAL_DATACENTER:-datacenter1}"
      SCYLLA_KEYSPACE: "${SCYLLA_KEYSPACE:-gryt}"
      S3_ENDPOINT: "http://minio:9000"
      S3_REGION: "${S3_REGION:-us-east-1}"
      S3_FORCE_PATH_STYLE: "true"
      S3_BUCKET: "${S3_BUCKET:-gryt}"
      S3_ACCESS_KEY_ID: "${MINIO_ROOT_USER:-minioadmin}"
      S3_SECRET_ACCESS_KEY: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      # Required in production
      JWT_SECRET: "${JWT_SECRET:?Set JWT_SECRET in deploy/host/.env (generate with: openssl rand -base64 48)}"
    ports:
      - "${BIND_ADDR:-127.0.0.1}:${SERVER_HTTP_PORT:-5000}:5000"
    volumes:
      - ../../server/public:/app/public:ro
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      sfu:
        condition: service_healthy
      scylla:
        condition: service_healthy
      minio:
        condition: service_started
      minio-init:
        condition: service_completed_successfully

  sfu:
    build:
      context: ../..
      dockerfile: Dockerfile.sfu
    container_name: gryt-sfu
    env_file:
      - ./.env
    environment:
      PORT: "5005"
      STUN_SERVERS: "${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}"
      ICE_UDP_PORT_MIN: "${SFU_UDP_MIN:-10000}"
      ICE_UDP_PORT_MAX: "${SFU_UDP_MAX:-10019}"
      ICE_ADVERTISE_IP: "${SFU_ADVERTISE_IP:-}"
      DISABLE_STUN: "${SFU_DISABLE_STUN:-false}"
      MAX_PEERS: "${SFU_MAX_PEERS:-}"
    ports:
      # SFU websocket (HTTP) for signaling (Cloudflare Tunnel will proxy this as HTTPS/WSS)
      - "${BIND_ADDR:-127.0.0.1}:${SFU_WS_PORT:-5005}:5005"
      # WebRTC media (UDP). Must be reachable from the public internet (not via Cloudflare).
      - "${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}:${SFU_UDP_MIN:-10000}-${SFU_UDP_MAX:-10019}/udp"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5005/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  scylla:
    image: scylladb/scylla:latest
    container_name: gryt-scylla
    command: ["--overprovisioned", "1", "--smp", "1"]
    volumes:
      - gryt-scylla-data:/var/lib/scylla
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'DESCRIBE KEYSPACES' 127.0.0.1 9042 >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 40s

  minio:
    image: minio/minio:latest
    container_name: gryt-minio
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin}"
    ports:
      - "${BIND_ADDR:-127.0.0.1}:${MINIO_API_PORT:-9000}:9000"
      - "${BIND_ADDR:-127.0.0.1}:${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - gryt-minio-data:/data
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    container_name: gryt-minio-init
    depends_on:
      - minio
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      S3_BUCKET: "${S3_BUCKET:-gryt}"
    entrypoint: ["/bin/sh", "-lc"]
    command: |
      set -e
      echo "Waiting for MinIO..."
      for i in $(seq 1 60); do
        if mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD" >/dev/null 2>&1; then
          break
        fi
        sleep 1
      done
      mc mb -p "local/$$S3_BUCKET" >/dev/null 2>&1 || true
      echo "MinIO bucket ensured: $$S3_BUCKET"
    restart: "no"

volumes:
  gryt-scylla-data:
  gryt-minio-data:

