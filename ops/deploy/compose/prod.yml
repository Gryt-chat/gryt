name: gryt-prod

services:
  # ── Object Storage ───────────────────────────────────────────────────────
  minio:
    image: minio/minio:latest
    container_name: gryt-prod-minio
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - gryt-prod-minio-data:/data
    networks:
      - gryt-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  minio-init:
    image: minio/mc:latest
    container_name: gryt-prod-minio-init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-gryt}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        echo "Configuring MinIO..."
        mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD"
        mc mb -p "local/$$S3_BUCKET" 2>/dev/null || true
        echo "Bucket ready: $$S3_BUCKET"
    networks:
      - gryt-prod
    restart: "no"

  server-data-init:
    image: alpine:3
    container_name: gryt-prod-server-data-init
    command: ["/bin/sh", "-c", "mkdir -p /data && chown -R 1001:1001 /data"]
    volumes:
      - gryt-prod-server-data:/data
    networks:
      - gryt-prod
    restart: "no"

  # ── SFU (Media Server) ────────────────────────────────────────────────────
  sfu:
    image: ghcr.io/gryt-chat/sfu:${SFU_VERSION:-latest}
    container_name: gryt-prod-sfu
    ports:
      - "${SFU_PORT:-5005}:5005"
      - "${ICE_UDP_MUX_PORT:-443}:${ICE_UDP_MUX_PORT:-443}/udp"
    environment:
      PORT: "5005"
      STUN_SERVERS: ${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}
      ICE_UDP_MUX_PORT: ${ICE_UDP_MUX_PORT:-443}
      ICE_ADVERTISE_IP: ${ICE_ADVERTISE_IP:-}
    networks:
      - gryt-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ── Signaling Server ───────────────────────────────────────────────────────
  server:
    image: ghcr.io/gryt-chat/server:${SERVER_VERSION:-latest}
    container_name: gryt-prod-server
    ports:
      - "${SERVER_PORT:-5000}:5000"
    environment:
      PORT: "5000"
      NODE_ENV: production
      SERVER_NAME: ${SERVER_NAME:-My Gryt Server}
      SERVER_DESCRIPTION: ${SERVER_DESCRIPTION:-A Gryt voice chat server}
      SERVER_PASSWORD: ${SERVER_PASSWORD:-}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://127.0.0.1:15738,https://app.gryt.chat}
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET in .env.prod}
      SFU_WS_HOST: ws://sfu:5005
      SFU_PUBLIC_HOST: ${SFU_PUBLIC_HOST:-ws://localhost:5005}
      STUN_SERVERS: ${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}
      SFU_UDP_PORT_MIN: ${SFU_UDP_MIN:-10000}
      SFU_UDP_PORT_MAX: ${SFU_UDP_MAX:-10019}
      GRYT_AUTH_MODE: ${GRYT_AUTH_MODE:-required}
      GRYT_OIDC_ISSUER: ${GRYT_OIDC_ISSUER:-https://auth.gryt.chat/realms/gryt}
      GRYT_OIDC_AUDIENCE: ${GRYT_OIDC_AUDIENCE:-gryt-web}
      GRYT_AUTH_API: ${GRYT_AUTH_API:-https://auth.gryt.chat}
      GRYT_IDENTITY_JWKS_URL: ${GRYT_IDENTITY_JWKS_URL:-https://id.gryt.chat/.well-known/jwks.json}
      DATA_DIR: /data
      S3_ENDPOINT: http://minio:9000
      S3_REGION: auto
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-gryt}
      S3_FORCE_PATH_STYLE: "true"
    volumes:
      - gryt-prod-server-data:/data
    depends_on:
      sfu:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      server-data-init:
        condition: service_completed_successfully
    networks:
      - gryt-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ── Image Worker ──────────────────────────────────────────────────────────
  image-worker:
    image: ghcr.io/gryt-chat/image-worker:${IMAGE_WORKER_VERSION:-latest}
    container_name: gryt-prod-image-worker
    environment:
      DATA_DIR: /data
      S3_ENDPOINT: http://minio:9000
      S3_REGION: auto
      S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-gryt}
      S3_FORCE_PATH_STYLE: "true"
    volumes:
      - gryt-prod-server-data:/data
    depends_on:
      server:
        condition: service_healthy
    networks:
      - gryt-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ── Web Client (dev / local only) ─────────────────────────────────────────
  # The web client won't authenticate against auth.gryt.chat in production
  # unless your domain is registered as a redirect URI (only official Gryt
  # domains are whitelisted). Use for local development or with your own
  # Keycloak. Enable with: docker compose --profile web up -d
  client:
    image: ghcr.io/gryt-chat/client:${CLIENT_VERSION:-latest}
    container_name: gryt-prod-client
    profiles: ["web"]
    ports:
      - "${CLIENT_PORT:-3666}:80"
    environment:
      GRYT_OIDC_ISSUER: ${GRYT_OIDC_ISSUER:-https://auth.gryt.chat/realms/gryt}
      GRYT_OIDC_REALM: ${GRYT_OIDC_REALM:-gryt}
      GRYT_OIDC_CLIENT_ID: ${GRYT_OIDC_CLIENT_ID:-gryt-web}
    depends_on:
      server:
        condition: service_healthy
    networks:
      - gryt-prod
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ── Monitoring (optional) ──────────────────────────────────────────────────
  # Enable with: docker compose --profile monitoring up -d

  prometheus:
    image: prom/prometheus:v3.5.0
    container_name: gryt-prod-prometheus
    profiles: ["monitoring"]
    ports:
      - "127.0.0.1:${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - gryt-prod-prometheus-data:/prometheus
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /tmp/prometheus.yml <<'CFG'
        global:
          scrape_interval: 15s
        scrape_configs:
          - job_name: gryt-server
            static_configs:
              - targets: ["server:5000"]
          - job_name: gryt-sfu
            static_configs:
              - targets: ["sfu:5005"]
        CFG
        exec /bin/prometheus --config.file=/tmp/prometheus.yml
    networks:
      - gryt-prod
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.6.0
    container_name: gryt-prod-grafana
    profiles: ["monitoring"]
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "127.0.0.1:${GRAFANA_PORT:-3000}:3000"
    volumes:
      - gryt-prod-grafana-data:/var/lib/grafana
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat > /etc/grafana/provisioning/datasources/prometheus.yml <<'CFG'
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            access: proxy
            url: http://prometheus:9090
            isDefault: true
            editable: false
        CFG
        exec /run.sh
    networks:
      - gryt-prod
    restart: unless-stopped

networks:
  gryt-prod:
    driver: bridge

volumes:
  gryt-prod-server-data:
  gryt-prod-minio-data:
  gryt-prod-prometheus-data:
  gryt-prod-grafana-data:
